{
  "version": 3,
  "sources": ["../../client-typescript/telnet_negotiation.ts"],
  "sourcesContent": ["enum Options {\r\n    ECHO = 1,\r\n    MUDServerStatusProtocolVariable = 1,\r\n    MUDServerStatusProtocolValue = 2,\r\n    SupressGoAhead = 3,\r\n    TelnetType = 24,\r\n    MUDServerStatusProtocol = 70,\r\n    MUDSoundProtocol = 90,\r\n    MUDeXtensionProtocol = 91,\r\n    SubNegotiationEnd = 240,\r\n    GoAhead = 249,\r\n    SubNegotiation = 250,\r\n    WILL = 251,\r\n    DO = 253,\r\n    WONT = 252,\r\n    DONT = 254,\r\n    InterpretAsCommand = 255,\r\n}\r\n\r\nexport class TelnetOption {\r\n    public Enabled: boolean = false;\r\n}\r\n\r\nexport class EchoOption extends TelnetOption {}\r\n\r\nexport class SupressGoAhead extends TelnetOption {}\r\n\r\nexport class NegotiateResponse {\r\n    public NewInput: Uint8Array = new Uint8Array();\r\n    public Response: Uint8Array = new Uint8Array();\r\n}\r\n\r\nexport class TelnetNegotiator {\r\n    public Options: Array<TelnetOption> = [];\r\n    private SupportedClientTypes: Array<string> = [\"256COLOR\", \"VT100\", \"ANSI\", \"TRUECOLOR\"];\r\n    private NegotiatedClientTypes: Array<string> = [];\r\n    private currentTypeIndex: number = -1;\r\n\r\n    private readonly ClientNegotiateTelnetType: Uint8Array = new Uint8Array([\r\n        Options.InterpretAsCommand,\r\n        Options.SubNegotiation,\r\n        Options.TelnetType,\r\n        0\r\n    ]);\r\n\r\n    public IsNegotiationRequired(input: Uint8Array): boolean {\r\n        return input.includes(Options.InterpretAsCommand);\r\n    }\r\n\r\n    public Negotiate(input: Uint8Array): NegotiateResponse {\r\n        const response = new NegotiateResponse();\r\n        let i = 0;\r\n        let lastIndex = 0;\r\n        \r\n        while (i < input.length) {\r\n            if (input[i] === Options.InterpretAsCommand) {\r\n                response.NewInput = this.concatUint8Arrays(response.NewInput, input.slice(lastIndex, i));\r\n                i++; // Move past IAC\r\n                if (i >= input.length) break;\r\n\r\n                const command = input[i];\r\n                i++; // Move past command\r\n\r\n                switch (command) {\r\n                    case Options.DO:\r\n                    case Options.DONT:\r\n                    case Options.WILL:\r\n                    case Options.WONT:\r\n                        if (i >= input.length) break;\r\n                        const option = input[i];\r\n                        i++; // Move past option\r\n                        response.Response = this.concatUint8Arrays(response.Response, this.handleCommand(command, option));\r\n                        break;\r\n                    \r\n                    case Options.SubNegotiation:\r\n                        const subNegResponse = this.handleSubNegotiation(input.slice(i));\r\n                        response.Response = this.concatUint8Arrays(response.Response, subNegResponse);\r\n                        i += this.findSubNegotiationEnd(input.slice(i)) + 1;\r\n                        break;\r\n                }\r\n                lastIndex = i;\r\n            } else {\r\n                i++; // Move to next character if not IAC\r\n            }\r\n        }\r\n        \r\n        response.NewInput = this.concatUint8Arrays(response.NewInput, input.slice(lastIndex));\r\n\r\n        return response;\r\n    }\r\n\r\n    private handleCommand(command: number, option: number): Uint8Array {\r\n        switch (option) {\r\n            case Options.TelnetType:\r\n                if (command === Options.DO || command === Options.WILL) {\r\n                    return this.SendNextClientType();\r\n                }\r\n                break;\r\n            // Add more cases for other options as needed\r\n        }\r\n        return new Uint8Array();\r\n    }\r\n\r\n    private handleSubNegotiation(input: Uint8Array): Uint8Array {\r\n        if (input[0] === Options.TelnetType && input[1] === 1) {\r\n            return this.SendNextClientType();\r\n        }\r\n        return new Uint8Array();\r\n    }\r\n\r\n    private findSubNegotiationEnd(input: Uint8Array): number {\r\n        for (let i = 0; i < input.length - 1; i++) {\r\n            if (input[i] === Options.InterpretAsCommand && \r\n                input[i + 1] === Options.SubNegotiationEnd) {\r\n                return i + 1;\r\n            }\r\n        }\r\n        return input.length;\r\n    }\r\n\r\n    public SendNextClientType(): Uint8Array {\r\n        this.currentTypeIndex = (this.currentTypeIndex + 1) % this.SupportedClientTypes.length;\r\n        const clientType = this.SupportedClientTypes[this.currentTypeIndex];\r\n        \r\n        const clientTypeBytes = new TextEncoder().encode(clientType);\r\n        return this.concatUint8Arrays(\r\n            this.ClientNegotiateTelnetType,\r\n            clientTypeBytes,\r\n            new Uint8Array([Options.InterpretAsCommand, Options.SubNegotiationEnd])\r\n        );\r\n    }\r\n\r\n    private concatUint8Arrays(...arrays: Uint8Array[]): Uint8Array {\r\n        const totalLength = arrays.reduce((acc, value) => acc + value.length, 0);\r\n        const result = new Uint8Array(totalLength);\r\n        let offset = 0;\r\n        for (const array of arrays) {\r\n            result.set(array, offset);\r\n            offset += array.length;\r\n        }\r\n        return result;\r\n    }\r\n}"],
  "mappings": "AAmBO,IAAMA,EAAN,KAAmB,CAAnB,cACH,KAAO,QAAmB,GAC9B,EAEaC,EAAN,cAAyBD,CAAa,CAAC,EAEjCE,EAAN,cAA6BF,CAAa,CAAC,EAErCG,EAAN,KAAwB,CAAxB,cACH,KAAO,SAAuB,IAAI,WAClC,KAAO,SAAuB,IAAI,WACtC,EAEaC,EAAN,KAAuB,CAAvB,cACH,KAAO,QAA+B,CAAC,EACvC,KAAQ,qBAAsC,CAAC,WAAY,QAAS,OAAQ,WAAW,EACvF,KAAQ,sBAAuC,CAAC,EAChD,KAAQ,iBAA2B,GAEnC,KAAiB,0BAAwC,IAAI,WAAW,CACpE,IACA,IACA,GACA,CACJ,CAAC,EAEM,sBAAsBC,EAA4B,CACrD,OAAOA,EAAM,SAAS,GAA0B,CACpD,CAEO,UAAUA,EAAsC,CACnD,IAAMC,EAAW,IAAIH,EACjBI,EAAI,EACJC,EAAY,EAEhB,KAAOD,EAAIF,EAAM,QACb,GAAIA,EAAME,CAAC,IAAM,IAA4B,CAGzC,GAFAD,EAAS,SAAW,KAAK,kBAAkBA,EAAS,SAAUD,EAAM,MAAMG,EAAWD,CAAC,CAAC,EACvFA,IACIA,GAAKF,EAAM,OAAQ,MAEvB,IAAMI,EAAUJ,EAAME,CAAC,EAGvB,OAFAA,IAEQE,EAAS,CACb,IAAK,KACL,IAAK,KACL,IAAK,KACL,IAAK,KACD,GAAIF,GAAKF,EAAM,OAAQ,MACvB,IAAMK,EAASL,EAAME,CAAC,EACtBA,IACAD,EAAS,SAAW,KAAK,kBAAkBA,EAAS,SAAU,KAAK,cAAcG,EAASC,CAAM,CAAC,EACjG,MAEJ,IAAK,KACD,IAAMC,EAAiB,KAAK,qBAAqBN,EAAM,MAAME,CAAC,CAAC,EAC/DD,EAAS,SAAW,KAAK,kBAAkBA,EAAS,SAAUK,CAAc,EAC5EJ,GAAK,KAAK,sBAAsBF,EAAM,MAAME,CAAC,CAAC,EAAI,EAClD,KACR,CACAC,EAAYD,CAChB,MACIA,IAIR,OAAAD,EAAS,SAAW,KAAK,kBAAkBA,EAAS,SAAUD,EAAM,MAAMG,CAAS,CAAC,EAE7EF,CACX,CAEQ,cAAcG,EAAiBC,EAA4B,CAC/D,OAAQA,EAAQ,CACZ,IAAK,IACD,GAAID,IAAY,KAAcA,IAAY,IACtC,OAAO,KAAK,mBAAmB,EAEnC,KAER,CACA,OAAO,IAAI,UACf,CAEQ,qBAAqBJ,EAA+B,CACxD,OAAIA,EAAM,CAAC,IAAM,IAAsBA,EAAM,CAAC,IAAM,EACzC,KAAK,mBAAmB,EAE5B,IAAI,UACf,CAEQ,sBAAsBA,EAA2B,CACrD,QAASE,EAAI,EAAGA,EAAIF,EAAM,OAAS,EAAGE,IAClC,GAAIF,EAAME,CAAC,IAAM,KACbF,EAAME,EAAI,CAAC,IAAM,IACjB,OAAOA,EAAI,EAGnB,OAAOF,EAAM,MACjB,CAEO,oBAAiC,CACpC,KAAK,kBAAoB,KAAK,iBAAmB,GAAK,KAAK,qBAAqB,OAChF,IAAMO,EAAa,KAAK,qBAAqB,KAAK,gBAAgB,EAE5DC,EAAkB,IAAI,YAAY,EAAE,OAAOD,CAAU,EAC3D,OAAO,KAAK,kBACR,KAAK,0BACLC,EACA,IAAI,WAAW,CAAC,IAA4B,GAAyB,CAAC,CAC1E,CACJ,CAEQ,qBAAqBC,EAAkC,CAC3D,IAAMC,EAAcD,EAAO,OAAO,CAACE,EAAKC,IAAUD,EAAMC,EAAM,OAAQ,CAAC,EACjEC,EAAS,IAAI,WAAWH,CAAW,EACrCI,EAAS,EACb,QAAWC,KAASN,EAChBI,EAAO,IAAIE,EAAOD,CAAM,EACxBA,GAAUC,EAAM,OAEpB,OAAOF,CACX,CACJ",
  "names": ["TelnetOption", "EchoOption", "SupressGoAhead", "NegotiateResponse", "TelnetNegotiator", "input", "response", "i", "lastIndex", "command", "option", "subNegResponse", "clientType", "clientTypeBytes", "arrays", "totalLength", "acc", "value", "result", "offset", "array"]
}
